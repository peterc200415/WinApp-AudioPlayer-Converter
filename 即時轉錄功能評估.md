# 即時轉錄功能評估報告

## 📋 當前實現分析

### 現有功能狀態

#### 1. 字幕檢查機制
- **位置**：`AudioPlayer.load_file()` (第 72-80 行)
- **行為**：載入音頻時檢查對應的 SRT 檔案
- **結果**：如果不存在，設置 `current_subtitles = []`（空列表）

#### 2. 背景轉錄功能
- **位置**：`MainWindow._transcribe_playlist_background()` (第 152-167 行)
- **觸發條件**：只在 `config.auto_transcribe == True` 時執行
- **執行方式**：背景執行緒，遍歷整個播放列表
- **問題**：
  - ❌ 需要手動開啟配置
  - ❌ 不針對當前播放的檔案優先處理
  - ❌ 轉錄完成後不會自動載入字幕

#### 3. 字幕顯示機制
- **位置**：`AudioPlayer._update_subtitles()` (背景執行緒)
- **行為**：定期檢查當前播放時間，匹配字幕
- **問題**：
  - ❌ 如果 `current_subtitles` 為空，不會顯示任何內容

---

## 🎯 用戶需求

**核心需求**：當播放沒有字幕的音頻時，**即時自動轉錄並顯示字幕**

**預期行為**：
1. 檢測到音頻檔案沒有對應的 SRT 檔案
2. 立即觸發 Whisper 轉錄（顯示轉錄進度）
3. 轉錄完成後自動載入字幕
4. 字幕開始即時顯示
5. 轉錄過程中可以繼續播放音頻（無字幕狀態）

---

## 🔍 技術評估

### 方案一：播放時即時檢測並轉錄（推薦）

#### 流程設計
```
播放音頻
  ↓
AudioPlayer.load_file() 檢測字幕
  ↓
沒有字幕？
  ├─ 是 → 通知 MainWindow 觸發轉錄
  │         ├─ 顯示 "正在轉錄中..."
  │         ├─ 背景執行 Whisper 轉錄
  │         ├─ 轉錄完成 → 保存 SRT
  │         └─ 重新載入字幕 → 開始顯示
  └─ 否 → 正常載入字幕
```

#### 優點
- ✅ 自動觸發，無需配置
- ✅ 優先處理當前播放檔案
- ✅ 用戶體驗流暢
- ✅ 轉錄完成後自動無縫切換

#### 缺點
- ⚠️ 首次播放需要等待轉錄（可選：播放開始後繼續轉錄）
- ⚠️ 轉錄是 CPU/GPU 密集型操作

#### 實現難點
1. **播放與轉錄的同步**：
   - 選項 A：等待轉錄完成再開始播放（體驗差）
   - 選項 B：邊播放邊轉錄，完成後自動載入（推薦）

2. **狀態管理**：
   - 轉錄中狀態標記
   - UI 進度顯示
   - 轉錄失敗處理

3. **性能考量**：
   - 轉錄耗時（base 模型約 1-5 分鐘/10分鐘音頻）
   - 不阻塞 UI 和播放

---

### 方案二：播放前預檢測（改進版）

#### 流程設計
```
選擇播放檔案
  ↓
檢查字幕是否存在
  ├─ 不存在 → 彈出確認對話框
  │           "沒有字幕，是否立即轉錄？"
  │           ├─ 是 → 轉錄後播放
  │           └─ 否 → 直接播放（無字幕）
  └─ 存在 → 正常播放
```

#### 優點
- ✅ 用戶可選擇是否轉錄
- ✅ 避免意外等待

#### 缺點
- ❌ 需要用戶互動（降低自動化）
- ❌ 不符合"即時"需求

---

### 方案三：混合模式（最靈活）

#### 設計
- **配置選項**：`auto_transcribe_on_play`（默認 `true`）
- **行為**：
  - 如果 `auto_transcribe_on_play == true`：播放時自動觸發轉錄
  - 如果 `false`：顯示提示，詢問是否轉錄

---

## 📊 實現複雜度評估

| 任務 | 複雜度 | 預計時間 | 優先級 |
|------|--------|----------|--------|
| 在 `load_file()` 檢測並觸發轉錄 | 低 | 30分鐘 | 高 |
| 添加轉錄中狀態管理 | 中 | 1小時 | 高 |
| UI 顯示轉錄進度 | 中 | 1小時 | 中 |
| 轉錄完成後自動重新載入字幕 | 低 | 30分鐘 | 高 |
| 錯誤處理和重試機制 | 中 | 1小時 | 中 |
| 添加配置選項 | 低 | 15分鐘 | 低 |

**總計**：約 3-4 小時

---

## 💡 推薦實現方案

### 核心修改點

#### 1. 修改 `AudioPlayer.load_file()`
```python
def load_file(self, file_path: str) -> bool:
    # ... 現有代碼 ...
    
    # 載入字幕
    srt_path = get_srt_file_path(file_path)
    if os.path.exists(srt_path):
        self.current_subtitles = SubtitleParser.parse_srt(srt_path)
        self._subtitle_missing = False
    else:
        self.current_subtitles = []
        self._subtitle_missing = True  # 標記需要轉錄
        
    # ... 其餘代碼 ...
```

#### 2. 添加回調機制
```python
# 在 AudioPlayer 中
self.on_subtitle_needed: Optional[Callable[[str], None]] = None

# 在 load_file() 中
if self._subtitle_missing and self.on_subtitle_needed:
    self.on_subtitle_needed(file_path)
```

#### 3. 在 `MainWindow` 中處理轉錄
```python
# 設置回調
self.player.on_subtitle_needed = self._on_subtitle_needed

def _on_subtitle_needed(self, audio_path: str) -> None:
    """處理需要轉錄字幕的情況"""
    # 顯示轉錄提示
    self.subtitle_display.update_subtitle(None)  # 清空
    self._log_message(f"正在轉錄: {os.path.basename(audio_path)}")
    
    # 啟動背景轉錄
    threading.Thread(
        target=self._transcribe_current_file, 
        args=(audio_path,),
        daemon=True
    ).start()

def _transcribe_current_file(self, audio_path: str) -> None:
    """轉錄當前播放的檔案"""
    try:
        srt_path = self.transcriber.transcribe_to_srt(
            audio_path,
            model_name=self.config.get("whisper_model", "base"),
            device=self.config.get("device", "auto")
        )
        # 轉錄完成，重新載入字幕
        self.root.after(0, self._reload_subtitles, audio_path)
        self._log_message(f"轉錄完成: {os.path.basename(audio_path)}")
    except Exception as e:
        self._log_message(f"轉錄失敗: {e}")

def _reload_subtitles(self, audio_path: str) -> None:
    """重新載入字幕"""
    if self.player.current_file == audio_path:
        # 重新載入檔案（會觸發字幕重新解析）
        srt_path = get_srt_file_path(audio_path)
        if os.path.exists(srt_path):
            self.player.current_subtitles = SubtitleParser.parse_srt(srt_path)
            self._log_message("字幕已載入")
```

---

## ⚠️ 注意事項

### 1. 性能考量
- **轉錄時間**：base 模型約為音頻時長的 0.1-0.5 倍（取決於硬體）
- **記憶體使用**：Whisper base 模型約需 1GB RAM
- **建議**：使用 GPU（CUDA）可大幅加速

### 2. 用戶體驗
- **提示訊息**：清楚顯示轉錄狀態
- **非阻塞**：不影響播放和其他操作
- **進度顯示**：可選（Whisper 沒有內建進度回調）

### 3. 錯誤處理
- 轉錄失敗時的處理
- 檔案權限問題
- 磁碟空間不足

### 4. 配置選項
- 預設啟用即時轉錄（`auto_transcribe_on_play: true`）
- 允許用戶關閉此功能

---

## 📝 實現步驟建議

1. **第一步**：添加 `on_subtitle_needed` 回調
2. **第二步**：實現 `_on_subtitle_needed` 處理函數
3. **第三步**：實現 `_transcribe_current_file` 轉錄函數
4. **第四步**：實現 `_reload_subtitles` 重新載入機制
5. **第五步**：添加 UI 狀態顯示
6. **第六步**：測試和調試
7. **第七步**：添加配置選項（可選）

---

## ✅ 總結

**當前狀態**：
- 已有轉錄功能，但需要手動開啟
- 轉錄不會針對當前播放檔案
- 轉錄完成後不會自動載入

**改進方向**：
- 自動檢測缺失字幕
- 立即觸發轉錄（不阻塞播放）
- 轉錄完成後自動載入並顯示

**推薦方案**：方案一（播放時即時檢測並轉錄）

**預估工作量**：3-4 小時

**優先級**：高（核心功能改進）
